name: Reusable build and test workflow
on:
  workflow_call:
    inputs:
      skipTest:
        required: false
        description: "whether to skip this workflow"
        type: boolean
env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
  TURBO_CACHE: remote:rw
jobs:
  build_typecheck:
    name: ğŸ” Build and typecheck
    uses: ./.github/workflows/build-reusable.yml
    if: ${{ !inputs.skipTest }}
    with:
      afterBuild: pnpm typecheck
      os: '["ubuntu-latest"]'
    secrets: inherit
  test-dev:
    name: âš«ï¸ Run Vitest (development mode) tests
    uses: ./.github/workflows/build-reusable.yml
    if: ${{ !inputs.skipTest }}
    with:
      afterBuild: TEST_MODE=dev pnpm test --filter='./__tests__/*'
    secrets: inherit
  test-prod:
    name: âš«ï¸ Run Vitest (production mode) tests
    uses: ./.github/workflows/build-reusable.yml
    if: ${{ !inputs.skipTest }}
    with:
      afterBuild: TEST_MODE=start pnpm test --filter='./__tests__/*'
    secrets: inherit
